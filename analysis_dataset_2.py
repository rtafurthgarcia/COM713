# originally from: 10.1109/ICSE-Companion66252.2025.00013 
# their result repo being stored here: https://zenodo.org/records/13882428

import json
import os
import matplotlib.pyplot as plt


## analyze data

tool2file = {
    "syft": "syft-cdx.json",
    "sbom-tool": "sbom-tool.spdx.json",
    "cve-bin-tool": "cve-bin-tool-cdx.json",
    "cdxgen": "cdxgen.json",
    "cyclonedx-python": "cdx-py-cdx-env.json",
    "sit": "midware.json"
}


# get ground truth
def get_gt(tree_path):
    dependencies = {}

    d = json.load(open(tree_path, "r"))
    for p in d:
        name = p["package"]["package_name"]
        # name = name.replace("_", "-")
        if dependencies.get(name, None) == None:
            dependencies[name] = []
        dep = dependencies.get(name, [])
        for a in p["dependencies"]:
            dep.append(a["package_name"])
            if dependencies.get(a["package_name"], None) == None:
                dependencies[a["package_name"]] = []
        dependencies[name] = dep
    return dependencies


# calculate precision and recall
def calc_pr(dep_tree: dict, all_cnt: int, tree_path: str) -> tuple:
    tp = 0
    dependencies = get_gt(tree_path)
    for k, v in dependencies.items():
        dep = dep_tree.get(k, None)
        if not dep and not v:
            if k in dep_tree:
                tp += 1
        elif dep and (set(v) == set(dep)):
            tp += 1
    return [tp, all_cnt - tp, len(dependencies.keys()) - tp]


# analyze sbom files
def parse_sbom(path, tool, tree_path):
    if tool in ["syft", "cve-bin-tool", "cdxgen", "cyclonedx-python"]:
        model = "cdx"
    else:
        model = "spdx"
    if model == "cdx":
        cdx_ref2name = {}
        cdx_dep = {}
        cdx_js = json.load(open(path, "r"))
        if cdx_js["metadata"].get("component", None):
            cdx_ref2name[cdx_js["metadata"]["component"]["bom-ref"]] = cdx_js["metadata"]["component"]["name"]
            cdx_dep[cdx_js["metadata"]["component"]["name"]] = []
        print(len(cdx_js["components"]))
        for cp in cdx_js["components"]:
            cdx_ref2name[cp["bom-ref"]] = cp["name"]
            if cp["type"].lower() == "library":
                cdx_dep[cp["name"]] = []
        for dp in cdx_js["dependencies"]:
            if dp["ref"] == "pkg:pypi/app@latest":
                continue
            name = cdx_ref2name[dp["ref"]]
            # name = name.replace("_", "-")
            cdx_dep[name] = []
            for d in dp.get("dependsOn", []):
                cdx_dep[name].append(cdx_ref2name[d])
        
        all_pkg = set()
        for k, v in cdx_dep.items():
            all_pkg.add(k)
            for pkg in v:
                all_pkg.add(pkg)
        for a in all_pkg:
            if not cdx_dep.get(a, None):
                cdx_dep[a] = []
        
        return calc_pr(cdx_dep, len(cdx_dep.keys()), tree_path)
    elif model == "spdx":
        spx_dep = {}
        spx_ref2name = {}
        spx_js = json.load(open(path, "r"))
        for pkg in spx_js["packages"]:
            spx_ref2name[pkg["SPDXID"]] = pkg["name"]
            spx_dep[pkg["name"]] = []

        for dp in spx_js["relationships"]:
            if dp["relationshipType"] == "DEPENDENCY_OF":
                k = dp["relatedSpdxElement"]
                name = spx_ref2name[k]
                # name = name.replace("_", "-")
                v = spx_dep.get(name, [])
                v.append(spx_ref2name[dp["spdxElementId"]])
                spx_dep[name] = v
            elif dp["relationshipType"] == "DEPENDS_ON":
                k = dp["spdxElementId"]
                name = spx_ref2name[k]
                # name = name.replace("_", "-")
                v = spx_dep.get(name, [])
                v.append(spx_ref2name[dp["relatedSpdxElement"]])
                spx_dep[name] = v
        
        all_pkg = set()
        for k, v in spx_dep.items():
            all_pkg.add(k)
            for pkg in v:
                all_pkg.add(pkg)
        for a in all_pkg:
            if not spx_dep.get(a, None):
                spx_dep[a] = []
        
        return calc_pr(spx_dep, len(spx_dep.keys()), tree_path)


# analyze sbom files generated by sit
def parse_sit(path, tree_path):
    spx_dep = {}
    spx_ref2name = {}
    spx_js = json.load(open(path, "r"))
    for pkg in spx_js["components"]:
        if "Package" in pkg["type"]:
            spx_ref2name[pkg["ID"]] = pkg["name"]
            spx_dep[pkg["name"]] = []

    for dp in spx_js["relationship"]:
        if dp["type"] == "DEPENDS_ON":
            k = dp["sourceID"]
            name = spx_ref2name[k]
            # name = name.replace("_", "-")
            v = spx_dep.get(name, [])
            v.append(spx_ref2name[dp["targetID"]])
            spx_dep[name] = v
    
    all_pkg = set()
    for k, v in spx_dep.items():
        all_pkg.add(k)
        for pkg in v:
            all_pkg.add(pkg)
    for a in all_pkg:
        if not spx_dep.get(a, None):
            spx_dep[a] = []
    
    return calc_pr(spx_dep, len(spx_dep.keys()), tree_path)



# TP: 本来在依赖树上，检测的也在树上
# TN: 本来不在依赖树上，检测的也不在树上 
# FP: 本来不在依赖树上，检测的在树上
# FN: 本来在依赖树上，检测的不在树上
# 节点在树上 + 依赖关系解析正确


## draw

def draw(data, output):
    precision = []
    recall = []
    labels = []
    for k, v in data.items():
        labels.append(k)
        sum_p = 0
        sum_r = 0
        for score in v:
            if k != "cyclonedx-python":
                score[1] -= 1
            p = score[0] / (score[0] + score[1]) * 100
            r = score[0] / (score[0] + score[2]) * 100
            sum_p += p
            sum_r += r
        precision.append(sum_p / 8)
        recall.append(sum_r / 8)
    print(precision, recall, labels)

    plt.figure()

    # 绘制网格
    plt.grid(True, which='both', linestyle='--', linewidth=0.5)

    # 绘制数据点
    plt.scatter(precision, recall, color='blue')
    for i, label in enumerate(labels):
        if label == 'cve-bin-tool':
            plt.annotate(label, (precision[i], recall[i]), textcoords="offset points", xytext=(8, -13), ha='center')
        # elif label == "sbom-tool":
        #     plt.annotate(label, (precision[i], recall[i]), textcoords="offset points", xytext=(12, 4), ha='center')
        elif label == "syft":
            plt.annotate(label, (precision[i], recall[i]), textcoords="offset points", xytext=(10,-12), ha='center')
        else:
            plt.annotate(label, (precision[i], recall[i]), textcoords="offset points", xytext=(10,-15), ha='center')

    # 设置标题和标签
    plt.xlabel('Precision [%]')
    plt.ylabel('Recall [%]')
    plt.title('Precision-Recall of SBOM Generator')

    # 设置轴范围
    plt.xlim(0, 100)
    plt.ylim(0, 100)

    # 显示图表
    plt.show()

    plt.savefig(output)


# {'syft': [[48, 73, 36], [27, 53, 47], [8, 15, 6], [18, 49, 30], [15, 15, 9], [46, 69, 50], [53, 90, 68], [32, 1224, 33]], 
# 'sbom-tool': [[43, 49, 41], [1, 4, 73], [7, 5, 7], [25, 22, 23], [10, 13, 14], [35, 92, 61], [7, 8, 114], [34, 1215, 31]], 
# 'cve-bin-tool': [[46, 48, 38], [40, 40, 34], [11, 26, 3], [28, 28, 20], [13, 13, 11], [57, 67, 39], [21, 30, 100], [40, 48, 25]], 
# 'cdxgen':         [[67, 135, 17], [52, 18, 22], [9, 27, 5], [37, 143, 11], [17, 92, 7], [69, 42, 27], [88, 41, 33], [47, 1311, 18]], 
# 'cyclonedx-python':[[60, 24, 24], [39, 35, 35], [12, 2, 2], [29, 19, 19], [21, 3, 3], [59, 37, 37], [62, 59, 59], [50, 15, 15]], 
# 'sit':         [[76, 9, 8], [56, 19, 18], [12, 3, 2], [32, 17, 16], [19, 6, 5], [54, 41, 42], [84, 37, 37], [45, 21, 20]],
# 'extra':          [[79, 6, 5], [60, 15, 14], [14, 1, 0], [37, 12, 11], [21, 4, 3], [67, 29, 29], [91, 30, 30], [51, 15, 14]]

# ['scancode-toolkit', 'django-rest-framework', 'apprise', 'ydata-profiling', 'impacket', 'keras', 'fastapi', 'InstaPy']

if __name__ == "__main__":
    result = {
        "syft": [],
        "sbom-tool": [],
        "cve-bin-tool": [],
        "cdxgen": [],
        "cyclonedx-python": [],
        "sit": []
    }

    root_path = "./sbom"
    p = os.listdir(root_path)
    print("order", p)
    # ['scancode-toolkit', 'django-rest-framework', 'apprise', 'ydata-profiling', 'impacket', 'keras', 'fastapi', 'InstaPy']
    for path in p:
        tree_path = f"./deptree_gt/{path}-deptree.json"
        bom_path = os.path.join(root_path, path)
        for tool, file in tool2file.items():
            print(tool, path)
            if tool == "sit":
                result[tool].append(parse_sit(os.path.join(bom_path, file), tree_path))
            else:
                result[tool].append(parse_sbom(os.path.join(bom_path, file), tool, tree_path))

    draw(result, "sbom-generator-pr.pdf")



